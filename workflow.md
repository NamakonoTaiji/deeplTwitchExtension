# Twitch DeepL Translator ワークフロー

## 基本フロー図

```
[拡張機能アイコンクリック] → [ポップアップUI表示] → [ON/OFF切り替え] → [設定保存]
                                                    ↓
[Twitchページ読み込み] → [コンテンツスクリプト実行] → [チャット監視開始]
                                                    ↓
                           ┌────────────────────── [新規コメント検出] ←─┐
                           ↓                                           │
                     [英語コメント判定] → [非英語の場合] → [処理終了] ────┘
                           ↓
                     [翻訳リクエスト] → [DeepL API] → [翻訳結果取得]
                           ↓
                     [翻訳表示処理] → [コメント下に翻訳表示]
```

## 主要ユースケースシナリオ

### ユースケース 1: 拡張機能の有効化

1. ユーザーが Chrome ツールバーの拡張機能アイコンをクリック
2. ポップアップ UI が表示される
3. ユーザーが ON ボタンをクリック
4. 設定が保存され、現在開いている Twitch タブに対して有効化される

### ユースケース 2: 新規コメントの翻訳

1. Twitch チャットに新しい英語コメントが表示される
2. MutationObserver が新規コメント要素を検出
3. コメントテキストを抽出して言語を判定
4. 英語コメントの場合、バックグラウンドスクリプトに翻訳リクエストを送信
5. バックグラウンドスクリプトが DeepL API に翻訳リクエストを送信
6. DeepL API から翻訳結果を受け取る
7. 翻訳結果をコンテンツスクリプトに返す
8. コンテンツスクリプトがコメント要素の下に翻訳テキストを挿入

### ユースケース 3: API キー設定

1. ユーザーがポップアップ UI の「設定」リンクをクリック
2. オプションページが開く
3. ユーザーが DeepL API キーを入力
4. 「保存」ボタンをクリック
5. API キーが Chrome Storage に保存される

## 主要コンポーネント間のデータフロー

### コンテンツスクリプト (content.js)

- 入力: DOM 変更イベント、バックグラウンドからの翻訳結果
- 出力: 翻訳リクエスト、DOM 更新（翻訳表示）
- 役割: ページ監視、コメント検出、翻訳表示

### バックグラウンドスクリプト (background.js)

- 入力: コンテンツスクリプトからの翻訳リクエスト、DeepL API からの応答
- 出力: DeepL API へのリクエスト、コンテンツスクリプトへの翻訳結果
- 役割: API 通信、拡張機能状態管理

### ポップアップ UI (popup.js)

- 入力: ユーザー操作、保存された設定
- 出力: 設定変更イベント
- 役割: ユーザー設定の UI 提供

### オプションページ (options.js)

- 入力: ユーザー入力、保存された設定
- 出力: 設定保存イベント
- 役割: 詳細設定の UI 提供

## 拡張機能ライフサイクル

### インストール時

1. 拡張機能がインストールされる
2. デフォルト設定が Chrome Storage に保存される
3. バックグラウンドスクリプトが初期化される

### Twitch ページアクセス時

1. ユーザーが Twitch ページにアクセス
2. コンテンツスクリプトが実行される
3. 設定が読み込まれ、有効になっている場合はコメント監視を開始

### コメント監視中

1. MutationObserver が DOM 変更を監視
2. 新規コメント要素が検出されたらテキスト抽出
3. 英語判定を行い、翻訳対象なら翻訳処理

### 拡張機能無効化時

1. ユーザーがポップアップ UI から OFF に切り替え
2. 設定が更新され、コンテンツスクリプトに通知
3. コメント監視が停止される

## エラーハンドリングフロー

### API キー未設定

1. 翻訳リクエスト時に API キーがないことを検出
2. エラーメッセージをコンテンツスクリプトに返す
3. コンテンツスクリプトがエラー通知を表示

### API 制限超過

1. DeepL API からレート制限エラーを受信
2. バックグラウンドスクリプトがエラーを検出
3. 一時的に翻訳リクエストを制限
4. エラー通知をコンテンツスクリプトに返す
